<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Profile - RentWheels</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="style.css">
    <script type="module">
        // Import the functions you need from the SDKs you need
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, updateDoc, collection, query, where, getDocs, orderBy, addDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
    
        // Your web app's Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBKtAnad888Ou7BRPoMPl60mJ2kpTlCH2o",
            authDomain: "vehicle-renting-343ac.firebaseapp.com",
            projectId: "vehicle-renting-343ac",
            storageBucket: "vehicle-renting-343ac.firebasestorage.app",
            messagingSenderId: "441312385232",
            appId: "1:441312385232:web:da6ef15efc30558e4f26d5"
        };
    
        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth();
        const db = getFirestore();

        // Check if user is logged in
        onAuthStateChanged(auth, (user) => {
            if (user) {
                console.log("User is signed in:", user.uid);
                loadUserData(user.uid);
                loadRentalHistory(user.uid);
            } else {
                console.log("No user is signed in");
                window.location.href = 'login.html';
            }
        });

        // Function to load user data
        async function loadUserData(userId) {
            try {
                console.log("Loading data for user:", userId);
                const userDoc = await getDoc(doc(db, "users", userId));
                
                if (userDoc.exists()) {
                    console.log("User data found:", userDoc.data());
                    const userData = userDoc.data();
                    
                    // Update profile header
                    document.getElementById('userName').textContent = userData.username || 'User';
                    document.getElementById('memberSince').textContent = `Member since ${new Date(userData.createdAt?.toDate()).toLocaleDateString() || '2024'}`;
                    
                    // Update stats
                    document.getElementById('totalRentals').textContent = userData.totalRentals || 0;
                    document.getElementById('userRating').textContent = userData.rating || 0.0;
                    document.getElementById('activeRentals').textContent = userData.activeRentals || 0;
                    
                    // Update personal information
                    document.getElementById('fullName').textContent = userData.username || 'Not provided';
                    document.getElementById('emailAddress').textContent = userData.email || 'Not provided';
                    document.getElementById('phoneNumber').textContent = userData.phoneNumber || 'Not provided';
                    document.getElementById('address').textContent = userData.address || 'Not provided';
                    document.getElementById('licenseNumber').textContent = userData.licenseNumber || 'Not provided';
                    document.getElementById('memberSinceDate').textContent = new Date(userData.createdAt?.toDate()).toLocaleDateString() || 'Not provided';
                    
                    // Update profile picture if available
                    if (userData.profilePicture) {
                        document.querySelector('.profile-avatar').src = userData.profilePicture;
                    }

                    // Update edit profile form fields
                    const editForm = document.getElementById('editProfileForm');
                    if (editForm) {
                        editForm.querySelector('#fullName').value = userData.username || '';
                        editForm.querySelector('#phoneNumber').value = userData.phoneNumber || '';
                        editForm.querySelector('#address').value = userData.address || '';
                    }
                } else {
                    console.log("No user document found");
                }
            } catch (error) {
                console.error("Error loading user data:", error);
                alert("Error loading profile data. Please try again later.");
            }
        }

        // Function to load rental history
        async function loadRentalHistory(userId) {
            try {
                const rentalHistoryRef = collection(db, "rental_history");
                const q = query(
                    rentalHistoryRef,
                    where("userId", "==", userId),
                    orderBy("createdAt", "desc")
                );

                const querySnapshot = await getDocs(q);
                const rentalHistoryContainer = document.querySelector('.rental-history');
                rentalHistoryContainer.innerHTML = ''; // Clear existing content

                if (querySnapshot.empty) {
                    rentalHistoryContainer.innerHTML = '<p class="no-rentals">No rental history found.</p>';
                    return;
                }

                let activeRentals = 0;
                querySnapshot.forEach((doc) => {
                    const rental = doc.data();
                    const rentalItem = createRentalItem(doc.id, rental);
                    rentalHistoryContainer.appendChild(rentalItem);

                    // Count active rentals
                    if (rental.status === 'active') {
                        activeRentals++;
                    }
                });

                // Update active rentals count
                document.getElementById('activeRentals').textContent = activeRentals;
                // Update total rentals count
                document.getElementById('totalRentals').textContent = querySnapshot.size;

            } catch (error) {
                console.error("Error loading rental history:", error);
                alert("Error loading rental history. Please try again later.");
            }
        }

        // Function to create rental item element
        function createRentalItem(rentalId, rental) {
            const rentalItem = document.createElement('div');
            rentalItem.className = 'rental-item';
            
            // Determine rental status
            const now = new Date();
            const pickupDate = new Date(rental.pickupDateTime);
            const dropoffDate = new Date(rental.dropoffDateTime);
            let status = 'completed';
            if (now < pickupDate) {
                status = 'upcoming';
            } else if (now >= pickupDate && now <= dropoffDate) {
                status = 'active';
            }

            rentalItem.innerHTML = `
                <img src="car_images/${rental.vehicleType.toLowerCase()}-${rental.vehicleModel.toLowerCase().replace(/\s+/g, '-')}.png" 
                     alt="${rental.vehicleModel}"
                     onerror="this.src='images/default-vehicle.png'">
                <div class="rental-details">
                    <h4>${rental.vehicleModel}</h4>
                    <p><i class="fas fa-calendar"></i> Rental Period: ${new Date(rental.pickupDateTime).toLocaleDateString()} - ${new Date(rental.dropoffDateTime).toLocaleDateString()}</p>
                    <p><i class="fas fa-map-marker-alt"></i> Pickup: ${rental.pickupLocation}</p>
                    <p><i class="fas fa-money-bill-wave"></i> Total Amount: à§³${rental.totalAmount.toLocaleString()}</p>
                    <p><i class="fas fa-car"></i> Vehicle Type: ${rental.vehicleType}</p>
                    <p><i class="fas fa-hashtag"></i> Registration: ${rental.registrationNumber}</p>
                </div>
                <div class="rental-actions">
                    <span class="rental-status status-${status}">${status.charAt(0).toUpperCase() + status.slice(1)}</span>
                    ${status === 'completed' ? `
                        <button class="btn btn-primary rate-btn" data-rental-id="${rentalId}">
                            <i class="fas fa-star"></i> Rate
                        </button>
                    ` : ''}
                </div>
            `;

            // Add click event for rate button
            const rateBtn = rentalItem.querySelector('.rate-btn');
            if (rateBtn) {
                rateBtn.addEventListener('click', () => {
                    const vehicleName = rental.vehicleModel;
                    const rentalPeriod = `${new Date(rental.pickupDateTime).toLocaleDateString()} - ${new Date(rental.dropoffDateTime).toLocaleDateString()}`;
                    document.getElementById('ratingVehicleName').textContent = vehicleName;
                    document.getElementById('ratingPeriod').textContent = rentalPeriod;
                    document.getElementById('ratingPopup').classList.add('show');
                });
            }

            return rentalItem;
        }

        // Handle edit profile form submission
        //const editProfileForm = document.getElementById('editProfileForm');
        if (editProfileForm) {
            editProfileForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                
                try {
                    const user = auth.currentUser;
                    if (!user) {
                        alert("You must be logged in to update your profile");
                        return;
                    }

                    const formData = {
                        username: document.getElementById('fullName').value,
                        phoneNumber: document.getElementById('phoneNumber').value,
                        address: document.getElementById('address').value
                    };

                    // Update Firestore
                    await updateDoc(doc(db, "users", user.uid), formData);
                    
                    // Update UI
                    loadUserData(user.uid);
                    
                    // Close popup
                    document.getElementById('editProfilePopup').classList.remove('show');
                    
                    alert('Profile updated successfully!');
                } catch (error) {
                    console.error("Error updating profile:", error);
                    alert("Error updating profile. Please try again later.");
                }
            });
        }

        // Add logout functionality
        document.getElementById('logout-btn').addEventListener('click', async (e) => {
            e.preventDefault();
            try {
                await signOut(auth);
                // Redirect to login page after successful logout
                window.location.href = 'login.html';
            } catch (error) {
                console.error('Error signing out:', error);
            }
        });
    </script>
</head>
<body>
    <!-- Menu Bar -->
    <div class="menu-bar">
        <a href="landing_page.html" style="text-decoration: none; color: black;"><h1 class="logo">Rent<span>Wheels</span></h1></a>
        <ul class="nav-menu">
            <li><a href="landing_page.html"><i class="fa-solid fa-house"></i> Home</a></li>
            <li class="dropdown">
                <a href="#"><i class="fas fa-car"></i> Vehicles <i class="fas fa-caret-down"></i></a>
                <div class="dropdown-menu">
                    <ul>
                        <li><a href="toyota_car_section.html">Toyota Cars</a></li>
                        <li><a href="honda_car_section.html">Honda Cars</a></li>
                        <li><a href="bmw_car_section.html">BMW Cars</a></li>
                        <li><a href="honda_bike_section.html">Honda Bikes</a></li>
                        <li><a href="tvs_bike_section.html">TVS Bikes</a></li>
                        <li><a href="yamaha_bike_section.html">Yamaha Bikes</a></li>
                        <li><a href="pickup_section.html">Pickup Trucks</a></li>
                        <li><a href="minivan_section.html">Minivans</a></li>
                    </ul>
                </div>
            </li>
            <li><a href="about_us.html"><i class="fas fa-info-circle"></i> About</a></li>
            <li><a href="contacts.html"><i class="fas fa-envelope"></i> Contact</a></li>
            <li><a href="profile.html" class="active"><i class="fas fa-user"></i> Profile</a></li>
            <li><a href="#" id="logout-btn"><i class="fas fa-sign-out-alt"></i> Logout</a></li>
        </ul>
        <div class="right-section">
            <div class="search">
                <input type="text" id="searchInput" placeholder="Search vehicles..." onkeyup="searchVehicles()"/>
                <i class="fa-solid fa-magnifying-glass" onclick="searchVehicles()"></i>
            </div>
            <a href="login.html" class="login-btn">
                <i class="fas fa-sign-in-alt"></i> Login
            </a>
            <div class="menu-toggle" id="menuToggle">
                <i class="fa-solid fa-bars"></i>
            </div>
        </div>
    </div>

    <div id="searchResults" class="search-results"></div>

    <!-- Profile Container -->
    <div class="profile-container">
        <!-- Profile Header -->
        <div class="profile-header">
            <img src="images/profile/avatar.jpg" alt="Profile Avatar" class="profile-avatar">
            <div class="profile-info-header">
                <h2 id="userName">Loading...</h2>
                <p id="memberSince">Loading...</p>
                <div class="profile-stats">
                    <div class="stat-item">
                        <h3 id="totalRentals">0</h3>
                        <p>Rentals</p>
                    </div>
                    <div class="stat-item">
                        <h3 id="userRating">0.0</h3>
                        <p>Rating</p>
                    </div>
                    <div class="stat-item">
                        <h3 id="activeRentals">0</h3>
                        <p>Active</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Profile Content -->
        <div class="profile-content">
            <!-- Profile Sidebar -->
            <div class="profile-sidebar">
                <h3>Navigation</h3>
                <ul class="profile-nav">
                    <li><a href="#personal-info" class="active"><i class="fas fa-user"></i> Personal Info</a></li>
                    <li><a href="#rental-history"><i class="fas fa-history"></i> Rental History</a></li>
                    <li><a href="#payment-methods"><i class="fas fa-credit-card"></i> Payment Methods</a></li>
                    <li><a href="#notifications"><i class="fas fa-bell"></i> Notifications</a></li>
                    <!-- <li><a href="#settings"><i class="fas fa-cog"></i> Settings</a></li> -->
                </ul>
            </div>

            <!-- Profile Main Content -->
            <div class="profile-main">
                <!-- Personal Information Section -->
                <div class="profile-section" id="personal-info">
                    <h3>Personal Information</h3>
                    <div class="profile-info">
                        <div class="info-group">
                            <label>Full Name</label>
                            <p id="fullName">Loading...</p>
                        </div>
                        <div class="info-group">
                            <label>Email Address</label>
                            <p id="emailAddress">Loading...</p>
                        </div>
                        <div class="info-group">
                            <label>Phone Number</label>
                            <p id="phoneNumber">Loading...</p>
                        </div>
                        <div class="info-group">
                            <label>Address</label>
                            <p id="address">Loading...</p>
                        </div>
                        <div class="info-group">
                            <label>License Number</label>
                            <p id="licenseNumber">Loading...</p>
                        </div>
                        <div class="info-group">
                            <label>Member Since</label>
                            <p id="memberSinceDate">Loading...</p>
                        </div>
                    </div>
                </div>

                <!-- Rental History Section -->
                <div class="profile-section" id="rental-history">
                    <h3>Rental History</h3>
                    <div class="rental-history">
                        <div class="rental-item">
                            <img src="car_images/toyota-car-1.png" alt="Toyota Camry">
                            <div class="rental-details">
                                <h4>Toyota Camry 2023</h4>
                                <p>Rental Period: Jan 15 - Jan 20, 2024</p>
                                <p>Total Amount: à§³50,000</p>
                            </div>
                            <div class="rental-actions">
                                <span class="rental-status status-completed">Completed</span>
                                <button class="btn btn-primary rate-btn" data-vehicle="Toyota Camry 2023" data-period="Jan 15 - Jan 20, 2024">
                                    <i class="fas fa-star"></i> Rate
                                </button>
                            </div>
                        </div>
                        <div class="rental-item">
                            <img src="car_images/honda-car-1.png" alt="Honda Civic">
                            <div class="rental-details">
                                <h4>Honda Civic 2023</h4>
                                <p>Rental Period: Feb 1 - Feb 5, 2024</p>
                                <p>Total Amount: à§³40,000</p>
                            </div>
                            <div class="rental-actions">
                                <span class="rental-status status-active">Active</span>
                            </div>
                        </div>
                        <div class="rental-item">
                            <img src="car_images/bmw-car-1.png" alt="BMW 3 Series">
                            <div class="rental-details">
                                <h4>BMW 3 Series 2023</h4>
                                <p>Rental Period: Dec 20 - Dec 25, 2023</p>
                                <p>Total Amount: à§³60,000</p>
                            </div>
                            <div class="rental-actions">
                                <span class="rental-status status-completed">Completed</span>
                                <button class="btn btn-primary rate-btn" data-vehicle="BMW 3 Series 2023" data-period="Dec 20 - Dec 25, 2023">
                                    <i class="fas fa-star"></i> Rate
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Profile Actions -->
                <div class="profile-actions">
                    <button class="btn btn-primary" id="editProfileBtn">
                        <i class="fas fa-edit"></i> Edit Profile
                    </button>
                    <button class="btn btn-outline">
                        <i class="fas fa-download"></i> Download History
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Notifications Popup -->
    <div class="notifications-popup" id="notificationsPopup">
        <div class="notifications-header">
            <h3>Notifications</h3>
            <button class="close-notifications" id="closeNotifications">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="notifications-list">
            <div class="notification-item unread">
                <i class="fas fa-car"></i>
                <div class="notification-content">
                    <p>Your Toyota Camry rental is due tomorrow</p>
                    <span class="notification-time">2 hours ago</span>
                    <div class="notification-details">
                        <div class="details-content">
                            <h4>Rental Details</h4>
                            <div class="detail-row">
                                <span class="detail-label">Vehicle:</span>
                                <span class="detail-value">Toyota Camry 2023</span>
                            </div>
                            <div class="detail-row">
                                <span class="detail-label">Rental Period:</span>
                                <span class="detail-value">Jan 15 - Jan 20, 2024</span>
                            </div>
                            <div class="detail-row">
                                <span class="detail-label">Return Location:</span>
                                <span class="detail-value">Downtown Branch</span>
                            </div>
                            <div class="detail-row">
                                <span class="detail-label">Rental Price:</span>
                                <span class="detail-value">à§³3,000 per day</span>
                            </div>
                            <div class="detail-row">
                                <span class="detail-label">Total Amount:</span>
                                <span class="detail-value">à§³50,000</span>
                            </div>
                            <div class="detail-actions">
                                <button class="btn btn-primary">View Details</button>
                                <button class="btn btn-secondary">Contact Support</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="notification-item">
                <i class="fas fa-star"></i>
                <div class="notification-content">
                    <p>You received a 5-star rating for your last rental</p>
                    <span class="notification-time">1 day ago</span>
                    <div class="notification-details">
                        <div class="details-content">
                            <h4>Rating Details</h4>
                            <div class="detail-row">
                                <span class="detail-label">Rating:</span>
                                <span class="detail-value">âââââ</span>
                            </div>
                            <div class="detail-row">
                                <span class="detail-label">Vehicle:</span>
                                <span class="detail-value">Honda Civic 2023</span>
                            </div>
                            <div class="detail-row">
                                <span class="detail-label">Comment:</span>
                                <span class="detail-value">Excellent service and vehicle condition!</span>
                            </div>
                            <div class="detail-actions">
                                <button class="btn btn-primary">View Full Review</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="notification-item">
                <i class="fas fa-percent"></i>
                <div class="notification-content">
                    <p>Special offer: 20% off on your next rental</p>
                    <span class="notification-time">2 days ago</span>
                    <div class="notification-details">
                        <div class="details-content">
                            <h4>Offer Details</h4>
                            <div class="detail-row">
                                <span class="detail-label">Discount:</span>
                                <span class="detail-value">20% OFF</span>
                            </div>
                            <div class="detail-row">
                                <span class="detail-label">Valid Until:</span>
                                <span class="detail-value">Feb 28, 2024</span>
                            </div>
                            <div class="detail-row">
                                <span class="detail-label">Code:</span>
                                <span class="detail-value">WELCOME20</span>
                            </div>
                            <div class="detail-actions">
                                <button class="btn btn-primary">Apply Code</button>
                                <button class="btn btn-secondary">Share Offer</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Profile Popup -->
    <div class="edit-profile-popup" id="editProfilePopup">
        <div class="edit-profile-content">
            <div class="edit-profile-header">
                <h3>Edit Profile</h3>
                <button class="close-edit-profile" id="closeEditProfile">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <form id="editProfileForm" class="edit-profile-form">
                <div class="avatar-upload">
                    <img src="images/profile/avatar.jpg" alt="Profile Avatar" id="previewAvatar">
                    <div class="avatar-upload-overlay">
                        <i class="fas fa-camera"></i>
                        <span>Change Photo</span>
                    </div>
                    <input type="file" id="avatarInput" accept="image/*" hidden>
                </div>
                <div class="form-group">
                    <label for="fullName">Full Name</label>
                    <input type="text" id="fullName" name="fullName" value="John Doe" required>
                </div>
                <div class="form-group">
                    <label for="phoneNumber">Phone Number</label>
                    <input type="tel" id="phoneNumber" name="phoneNumber" value="+1 234 567 8900" required>
                </div>
                <div class="form-group">
                    <label for="address">Address</label>
                    <textarea id="address" name="address" required>123 Main Street, City, Country</textarea>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" id="cancelEdit">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Changes</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Rating Popup -->
    <div class="rating-popup" id="ratingPopup">
        <div class="rating-content">
            <div class="rating-header">
                <h3>Rate Your Experience</h3>
                <button class="close-rating" id="closeRating">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <form id="ratingForm" class="rating-form">
                <div class="vehicle-info">
                    <h4 id="ratingVehicleName">Toyota Camry 2023</h4>
                    <p>Rental Period: <span id="ratingPeriod">Jan 15 - Jan 20, 2024</span></p>
                </div>
                <div class="rating-stars">
                    <div class="stars">
                        <i class="far fa-star" data-rating="1"></i>
                        <i class="far fa-star" data-rating="2"></i>
                        <i class="far fa-star" data-rating="3"></i>
                        <i class="far fa-star" data-rating="4"></i>
                        <i class="far fa-star" data-rating="5"></i>
                    </div>
                    <p class="rating-text">Select your rating</p>
                </div>
                <div class="form-group">
                    <label for="ratingComment">Your Review</label>
                    <textarea id="ratingComment" name="ratingComment" placeholder="Share your experience with this rental..." required></textarea>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" id="cancelRating">Cancel</button>
                    <button type="submit" class="btn btn-primary">Submit Review</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // Menu Toggle
        document.getElementById("menuToggle").addEventListener("click", function () {
            document.querySelector(".nav-menu").classList.toggle("show");
        });

        // Handle mobile dropdown
        const dropdowns = document.querySelectorAll('.dropdown');
        dropdowns.forEach(dropdown => {
            dropdown.addEventListener('click', function(e) {
                if (window.innerWidth <= 768) {
                    e.preventDefault();
                    this.classList.toggle('active');
                }
            });
        });

        // Search functionality
        function searchVehicles() {
            const searchInput = document.getElementById('searchInput');
            const searchResults = document.getElementById('searchResults');
            const searchTerm = searchInput.value.toLowerCase().trim();

            // Clear previous results
            searchResults.innerHTML = '';
            searchResults.style.display = 'none';

            if (searchTerm.length < 2) {
                return;
            }

            // Vehicle categories to search through
            const vehicleCategories = [
                { name: 'Toyota Cars', url: 'toyota_car_section.html' },
                { name: 'Honda Cars', url: 'honda_car_section.html' },
                { name: 'BMW Cars', url: 'bmw_car_section.html' },
                { name: 'Honda Bikes', url: 'honda_bike_section.html' },
                { name: 'TVS Bikes', url: 'tvs_bike_section.html' },
                { name: 'Yamaha Bikes', url: 'yamaha_bike_section.html' },
                { name: 'Pickup Trucks', url: 'pickup_section.html' },
                { name: 'Minivans', url: 'minivan_section.html' }
            ];

            // Filter vehicles based on search term
            const results = vehicleCategories.filter(vehicle => 
                vehicle.name.toLowerCase().includes(searchTerm)
            );

            if (results.length > 0) {
                searchResults.style.display = 'block';
                const resultsList = document.createElement('ul');
                results.forEach(result => {
                    const li = document.createElement('li');
                    const a = document.createElement('a');
                    a.href = result.url;
                    a.textContent = result.name;
                    li.appendChild(a);
                    resultsList.appendChild(li);
                });
                searchResults.appendChild(resultsList);
            }
        }

        // Profile Navigation
        const profileNavLinks = document.querySelectorAll('.profile-nav a');
        
        profileNavLinks.forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                profileNavLinks.forEach(l => l.classList.remove('active'));
                link.classList.add('active');
                
                const targetId = link.getAttribute('href').substring(1);
                const targetSection = document.getElementById(targetId);
                
                if (targetSection) {
                    targetSection.scrollIntoView({ behavior: 'smooth' });
                }
            });
        });

        // Notifications Popup
        const notificationsLink = document.querySelector('a[href="#notifications"]');
        const notificationsPopup = document.getElementById('notificationsPopup');
        const closeNotifications = document.getElementById('closeNotifications');

        notificationsLink.addEventListener('click', (e) => {
            e.preventDefault();
            notificationsPopup.classList.add('show');
        });

        closeNotifications.addEventListener('click', () => {
            notificationsPopup.classList.remove('show');
        });

        // Close popup when clicking outside
        window.addEventListener('click', (e) => {
            if (e.target === notificationsPopup) {
                notificationsPopup.classList.remove('show');
            }
        });

        // Notification Expansion
        const notificationItems = document.querySelectorAll('.notification-item');
        
        notificationItems.forEach(item => {
            item.addEventListener('click', () => {
                // Close other expanded notifications
                notificationItems.forEach(otherItem => {
                    if (otherItem !== item && otherItem.classList.contains('expanded')) {
                        otherItem.classList.remove('expanded');
                    }
                });
                
                // Toggle current notification
                item.classList.toggle('expanded');
            });
        });

        // Edit Profile Popup
        const editProfileBtn = document.getElementById('editProfileBtn');
        const editProfilePopup = document.getElementById('editProfilePopup');
        const closeEditProfile = document.getElementById('closeEditProfile');
        const cancelEdit = document.getElementById('cancelEdit');
        const editProfileForm = document.getElementById('editProfileForm');
        const avatarInput = document.getElementById('avatarInput');
        const previewAvatar = document.getElementById('previewAvatar');
        const avatarUpload = document.querySelector('.avatar-upload');

        // Open popup
        editProfileBtn.addEventListener('click', () => {
            editProfilePopup.classList.add('show');
        });

        // Close popup
        function closeEditProfilePopup() {
            editProfilePopup.classList.remove('show');
        }

        closeEditProfile.addEventListener('click', closeEditProfilePopup);
        cancelEdit.addEventListener('click', closeEditProfilePopup);

        // Close popup when clicking outside
        window.addEventListener('click', (e) => {
            if (e.target === editProfilePopup) {
                closeEditProfilePopup();
            }
        });

        // Handle avatar upload
        avatarUpload.addEventListener('click', () => {
            avatarInput.click();
        });

        avatarInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    previewAvatar.src = e.target.result;
                };
                reader.readAsDataURL(file);
            }
        });

        // Handle form submission
        editProfileForm.addEventListener('submit', (e) => {
            e.preventDefault();
            
            // Get form values
            const fullName = document.getElementById('fullName').value;
            const phoneNumber = document.getElementById('phoneNumber').value;
            const address = document.getElementById('address').value;
            
            // Update profile information
            document.querySelector('.profile-info-header h2').textContent = fullName;
            document.querySelector('.info-group:nth-child(1) p').textContent = fullName;
            document.querySelector('.info-group:nth-child(3) p').textContent = phoneNumber;
            document.querySelector('.info-group:nth-child(4) p').textContent = address;
            
            // Update avatar if changed
            if (avatarInput.files[0]) {
                document.querySelector('.profile-avatar').src = previewAvatar.src;
            }
            
            // Close popup
            closeEditProfilePopup();
            
            // Show success message
            alert('Profile updated successfully!');
        });

        // Rating System
        const ratingPopup = document.getElementById('ratingPopup');
        const closeRating = document.getElementById('closeRating');
        const cancelRating = document.getElementById('cancelRating');
        const ratingForm = document.getElementById('ratingForm');
        const stars = document.querySelectorAll('.stars i');
        const ratingText = document.querySelector('.rating-text');
        let currentRating = 0;

        // Open rating popup
        document.querySelectorAll('.rate-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                const vehicleName = btn.dataset.vehicle;
                const rentalPeriod = btn.dataset.period;
                document.getElementById('ratingVehicleName').textContent = vehicleName;
                document.getElementById('ratingPeriod').textContent = rentalPeriod;
                ratingPopup.classList.add('show');
            });
        });

        // Close rating popup
        function closeRatingPopup() {
            ratingPopup.classList.remove('show');
            resetRating();
        }

        closeRating.addEventListener('click', closeRatingPopup);
        cancelRating.addEventListener('click', closeRatingPopup);

        // Close popup when clicking outside
        window.addEventListener('click', (e) => {
            if (e.target === ratingPopup) {
                closeRatingPopup();
            }
        });

        // Star rating interaction
        stars.forEach(star => {
            star.addEventListener('mouseover', () => {
                const rating = star.dataset.rating;
                updateStars(rating);
                updateRatingText(rating);
            });

            star.addEventListener('mouseout', () => {
                updateStars(currentRating);
                updateRatingText(currentRating);
            });

            star.addEventListener('click', () => {
                currentRating = star.dataset.rating;
                updateStars(currentRating);
                updateRatingText(currentRating);
            });
        });

        function updateStars(rating) {
            stars.forEach(star => {
                const starRating = star.dataset.rating;
                if (starRating <= rating) {
                    star.classList.remove('far');
                    star.classList.add('fas');
                } else {
                    star.classList.remove('fas');
                    star.classList.add('far');
                }
            });
        }

        function updateRatingText(rating) {
            const texts = {
                0: 'Select your rating',
                1: 'Poor',
                2: 'Fair',
                3: 'Good',
                4: 'Very Good',
                5: 'Excellent'
            };
            ratingText.textContent = texts[rating] || texts[0];
        }

        function resetRating() {
            currentRating = 0;
            updateStars(0);
            updateRatingText(0);
            ratingForm.reset();
        }

        // Handle rating submission
        ratingForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            if (currentRating === 0) {
                alert('Please select a rating');
                return;
            }

            try {
                const user = auth.currentUser;
                if (!user) {
                    alert("You must be logged in to submit a rating");
                    return;
                }

                const comment = document.getElementById('ratingComment').value;
                const vehicleName = document.getElementById('ratingVehicleName').textContent;
                const rentalPeriod = document.getElementById('ratingPeriod').textContent;
                
                // Save rating to rental_history collection
                const ratingData = {
                    userId: user.uid,
                    vehicleName: vehicleName,
                    rentalPeriod: rentalPeriod,
                    rating: currentRating,
                    comment: comment,
                    createdAt: new Date()
                };

                await addDoc(collection(db, "rental_ratings"), ratingData);
                
                // Show success message
                alert('Thank you for your review!');
                
                // Close popup and reset form
                closeRatingPopup();
            } catch (error) {
                console.error("Error submitting rating:", error);
                alert("Error submitting rating. Please try again later.");
            }
        });

        // Function to set rental price based on vehicle type
        function setRentalPrice(vehicleName) {
            const priceElement = document.querySelector('.detail-row:has(.detail-label:contains("Rental Price")) .detail-value');
            if (!priceElement) return;

            let price = 0;
            if (vehicleName.toLowerCase().includes('bike')) {
                price = 1500;
            } else if (vehicleName.toLowerCase().includes('car')) {
                price = 3000;
            } else if (vehicleName.toLowerCase().includes('minivan') || vehicleName.toLowerCase().includes('pickup')) {
                price = 3500;
            }

            priceElement.textContent = `à§³${price.toLocaleString()} per day`;
        }

        // Update rental price when notification is clicked
        document.querySelectorAll('.notification-item').forEach(item => {
            item.addEventListener('click', () => {
                const vehicleName = item.querySelector('.detail-value').textContent;
                setRentalPrice(vehicleName);
            });
        });
    </script>

    <style>
        /* Add these styles to your existing CSS */
        .no-rentals {
            text-align: center;
            padding: 2rem;
            color: #666;
            font-size: 1.1rem;
        }

        .status-upcoming {
            background: #fff7e6;
            color: #fa8c16;
        }

        .rental-item img {
            width: 180px;
            height: 120px;
            object-fit: cover;
            border-radius: 8px;
        }

        .rental-details i {
            width: 20px;
            color: #666;
        }
    </style>
</body>
</html> 